stages:
  - build
  - publish

variables:
  ELECTRON_CACHE: $CI_PROJECT_DIR/.cache/electron
  ELECTRON_BUILDER_CACHE: $CI_PROJECT_DIR/.cache/electron-builder

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - .cache/

# Windows Build
build:windows:
  stage: build
  image: electronuserland/builder:wine
  tags:
    - docker
  only:
    - tags
    - web
  before_script:
    - apt-get update && apt-get install -y libfuse2
    - npm ci
  script:
    - npm run electron:build:win:nsis
  artifacts:
    paths:
      - release/*.exe
      - release/*.blockmap
    expire_in: 1 week

# Linux Build
build:linux:
  stage: build
  image: electronuserland/builder:base
  tags:
    - docker
  only:
    - tags
    - web
  before_script:
    - apt-get update && apt-get install -y libfuse2
    - npm ci
  script:
    - npm run electron:build:linux
  artifacts:
    paths:
      - release/*.AppImage
      - release/*.blockmap
    expire_in: 1 week

# Publish to GitHub Releases
publish:github:
  stage: publish
  image: alpine:latest
  tags:
    - docker
  only:
    - tags
  dependencies:
    - build:windows
    - build:linux
  before_script:
    - apk add --no-cache curl jq git
    - wget https://github.com/cli/cli/releases/download/v2.40.0/gh_2.40.0_linux_amd64.tar.gz
    - tar -xzf gh_2.40.0_linux_amd64.tar.gz
    - mv gh_2.40.0_linux_amd64/bin/gh /usr/local/bin/
  script:
    - |
      export VERSION=${CI_COMMIT_TAG#v}

      # Create release notes
      cat > release-notes.md << EOF
      ## ðŸŽ¨ Site Beta Melhorado

      - **SeÃ§Ãµes 3 e 4 refinadas**: AnimaÃ§Ãµes SVG mais sofisticadas e UI polida
      - **CentralizaÃ§Ã£o perfeita**: Workflow com setas reduzidas e espaÃ§amento otimizado
      - **Performance otimizada**: Smooth scroll inspirado no Lenis com easing suave
      - **SEO completo**: Open Graph, Twitter Cards, Schema.org
      - **Acessibilidade WCAG**: ARIA labels, navegaÃ§Ã£o por teclado, reduced-motion
      - **Mobile first**: Responsividade completa com touch targets adequados

      ### ðŸ“¦ Downloads

      **Windows:**
      - \`Zona21-${VERSION}.exe\` - Instalador NSIS

      **Linux:**
      - \`Zona21-${VERSION}.AppImage\` - AppImage universal

      **macOS:**
      - Visite [GitHub Releases](https://github.com/Almar-cyber/zona21-releases/releases/tag/${CI_COMMIT_TAG})
      EOF

      # Create or update release
      echo "$GH_PAT_RELEASES" | gh auth login --with-token

      gh release create "${CI_COMMIT_TAG}" \
        --repo Almar-cyber/zona21-releases \
        --title "${CI_COMMIT_TAG}" \
        --notes-file release-notes.md \
        release/*.exe \
        release/*.AppImage \
        release/*.blockmap \
        || gh release upload "${CI_COMMIT_TAG}" \
           --repo Almar-cyber/zona21-releases \
           --clobber \
           release/*.exe \
           release/*.AppImage \
           release/*.blockmap
